<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Image Voting App</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .image-container {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                justify-content: center;
            }
            .image-item {
                text-align: center;
                width: 220px;
            }
            img {
                max-width: 200px;
                max-height: 200px;
                object-fit: cover;
            }
            input {
                margin-top: 10px;
                padding: 5px;
                width: 100px;
            }
            button {
                margin-top: 5px;
                padding: 5px 10px;
            }
            .votes {
                margin-top: 10px;
                font-size: 14px;
            }
        </style>
    </head>
    <body>
        <h1>Image Voting App</h1>
        <div id="imageContainer" class="image-container">
            <!-- Images will be dynamically added here -->
        </div>

        <script>
            const JSONBIN_API_KEY =
                "$2a$10$tJauVcktjjo1lsYG4drgSueXU2HU9X6dyF/OSjhV91cpxdGr4RokW"; // Replace with your actual API key
            const JSONBIN_BIN_ID = "66a2b358acd3cb34a86b4987"; // Replace with your actual bin ID

            const imageUrls = [
                "images/1.png",
                "images/2.png",
                "images/3.png",
                "images/4.png",
            ];

            const imageContainer = document.getElementById("imageContainer");

            async function loadVotes() {
                const response = await fetch(
                    `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`,
                    {
                        headers: {
                            "X-Master-Key": JSONBIN_API_KEY,
                        },
                    },
                );
                const data = await response.json();
                return data.record || {};
            }

            async function saveVote(imageIndex, initials) {
                const votes = await loadVotes();
                if (!votes[imageIndex]) {
                    votes[imageIndex] = [];
                }
                votes[imageIndex].push(initials);

                await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Master-Key": JSONBIN_API_KEY,
                    },
                    body: JSON.stringify(votes),
                });
            }

            function displayVotes(votesElement, votes) {
                votesElement.innerHTML = votes
                    .map((initials) => `<span>${initials}</span>`)
                    .join(", ");
            }

            async function createImageElements() {
                const votes = await loadVotes();
                imageUrls.forEach((url, index) => {
                    const imageItem = document.createElement("div");
                    imageItem.className = "image-item";

                    const img = document.createElement("img");
                    img.src = url;
                    img.alt = `Image ${index + 1}`;

                    const input = document.createElement("input");
                    input.type = "text";
                    input.placeholder = "Your initials";
                    input.maxLength = 3;
                    input.id = `input-${index}`;

                    const publishButton = document.createElement("button");
                    publishButton.textContent = "Publish";
                    publishButton.addEventListener("click", async () => {
                        const initials = input.value.trim();
                        if (initials) {
                            await saveVote(index, initials);
                            input.value = "";
                            const updatedVotes = await loadVotes();
                            displayVotes(
                                votesElement,
                                updatedVotes[index] || [],
                            );
                        }
                    });

                    const votesElement = document.createElement("div");
                    votesElement.className = "votes";
                    displayVotes(votesElement, votes[index] || []);

                    imageItem.appendChild(img);
                    imageItem.appendChild(input);
                    imageItem.appendChild(publishButton);
                    imageItem.appendChild(votesElement);
                    imageContainer.appendChild(imageItem);
                });
            }

            createImageElements();
        </script>
    </body>
</html>
